<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title th:text="${product.name} + ' - Asta in Corso'">Dettaglio Asta</title>

    <!-- Link ai font e fogli di stile -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" th:href="@{/css/style.css}" />
</head>
<body>

    <div th:replace="~{navbar :: navbar}"></div>

    <!-- ================================================================ -->
    <!-- NUOVO: Contenitore per i Toast delle offerte (posizione corretta) -->
    <!-- ================================================================ -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
        <!-- Toast per le offerte (successo o errore) -->
        <div th:if="${bid_success != null or bid_error != null}"
             id="bidToast"
             class="toast"
             th:classappend="${bid_success} ? 'text-bg-success' : 'text-bg-danger'"
             role="alert"
             aria-live="assertive"
             aria-atomic="true">
            
            <div class="toast-header" th:classappend="${bid_success} ? 'text-bg-success' : 'text-bg-danger'">
                <i class="bi bi-info-circle-fill me-2"></i>
                <strong class="me-auto" th:text="${bid_success} ? 'Successo' : 'Errore'">Notifica</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" th:text="${bid_success ?: bid_error}">
                <!-- Il messaggio verrà inserito qui -->
            </div>
        </div>
    </div>
    <!-- ================================================================ -->
    <!-- Fine del blocco Toast                                            -->
    <!-- ================================================================ -->


    <div class="container-fluid p-3 p-lg-4 single-view-container">

        <!-- LAYOUT A 3 COLONNE -->
        <main class="row g-lg-4">

            <!-- Colonna 1: Immagine e Descrizione -->
            <div class="col-lg-4">
                <div class="activity-box product-column">
                    <img th:src="${product.imagePath != null} ? @{'/images/products/' + ${product.imagePath}} : 'https://placehold.co/600x400/1A1A1A/C9A227?text=SNKRS'"
                         class="main-image"
                         alt="Immagine Principale Sneaker">
                    <div class="scrollable-content">
                         <h1 class="product-title-main" th:text="${product.name}">Nome Prodotto Sneaker</h1>
                         <p class="product-description-main" th:text="${product.description}">Breve descrizione del prodotto.</p>
                    </div>
                </div>
            </div>

            <!-- Colonna 2: Pannello Asta (Centrale) -->
            <div class="col-lg-4">
                <div th:if="${!isAuctionExpired}" class="auction-panel-main">
                    
                    <div>
                        <small>Tempo Rimanente</small>
                        <div id="countdown-display" class="timer-display" th:attr="data-end-date=${product.auctionEndDate}">
                           Calcolo...
                        </div>
                    </div>
                    <small>L'asta termina il</small>
                    <div class="timer-display">
                        <span th:text="${#temporals.format(product.auctionEndDate, 'dd MMMM yyyy, HH:mm')}"></span>
                        <span th:text="CEST"></span>
                    </div>

                    <div th:if="${product.currentBid > product.startingPrice}">
                        <small>Offerta Attuale</small>
                        <div class="current-bid-amount"
                             th:classappend="${isUserWinning} ? 'winning-bid'"
                             th:text="'€ ' + ${#numbers.formatDecimal(product.currentBid, 1, 'POINT', 2, 'COMMA')}">
                            € 0,00
                        </div>
                        <div th:if="${isUserWinning}" class="winning-indicator">
                            <small><i class="bi bi-check-circle-fill"></i> La tua è l'offerta più alta!</small>
                        </div>
                        
                        <div sec:authorize="hasRole('ADMIN')" th:if="${product.highestBidder != null}" class="admin-bidder-info">
                            <small>OFFERENTE</small>
                            <div>
                                <span th:text="${product.highestBidder.name} + ' ' + ${product.highestBidder.surname}"></span>
                            </div>
                            <div>
                                <span th:text="${product.highestBidder.credentials.email}"></span>
                            </div>
                        </div>
                    </div>

                    <div th:unless="${product.currentBid > product.startingPrice}">
                        <small>Base Asta</small>
                        <div class="starting-price-display"
                             th:text="'€ ' + ${#numbers.formatDecimal(product.startingPrice, 1, 'POINT', 2, 'COMMA')}">
                            € 0,00
                        </div>
                    </div>
                    
                    <div sec:authorize="hasRole('ADMIN')" class="admin-actions mt-3">
                        <a th:href="@{/admin/editProduct/{id}(id=${product.id})}" class="btn btn-gold-outline w-100 mb-2">Modifica Asta</a>
                        <form th:action="@{/admin/deleteProduct/{id}(id=${product.id})}" method="post" onsubmit="return confirm('Sei sicuro di voler eliminare definitivamente questa asta?');">
                            <button type="submit" class="btn btn-danger-outline w-100">Elimina Asta</button>
                        </form>
                    </div>

                    <form th:action="@{/products/{id}/bid(id=${product.id})}" method="post" class="bid-form mt-3" sec:authorize="isAuthenticated() and  !hasRole('ADMIN')">
                        <div class="input-group mb-3">
                            <span class="input-group-text">€</span>
                            <input type="number" name="amount" class="form-control" placeholder="La tua offerta" required
                                   th:min="${product.currentBid + 1}" step="1">
                        </div>
                        <button type="submit" class="btn btn-gold w-100">Fai la tua Offerta</button>
                    </form>
                    <div sec:authorize="!isAuthenticated()">
                        <a th:href="@{/login}" class="btn btn-gold-outline w-100">Accedi per fare un'offerta</a>
                    </div>

                </div>

                <div th:if="${isAuctionExpired}" class="auction-panel-main">
                    <h2 class="text-center">Asta Terminata!</h2>
                    <div th:if="${winner != null}" class="text-center mt-3">
                            <small>OFFERTA FINALE</small>
                        <div class="current-bid-amount final-bid" th:text="'€ ' + ${#numbers.formatDecimal(product.currentBid, 1, 'POINT', 2, 'COMMA')}">
                            € 0,00
                        </div>
						<div sec:authorize="hasRole('ADMIN')" th:if="${product.highestBidder != null}" class="admin-bidder-info">
						                            <small>OFFERENTE</small>
						                            <div>
						                                <span th:text="${product.highestBidder.name} + ' ' + ${product.highestBidder.surname}"></span>
						                            </div>
						                            <div>
						                                <span th:text="${product.highestBidder.credentials.email}"></span>
						                            </div>
						                        </div>
                        <div th:if="${isCurrentUserTheWinner}" class="alert alert-success mt-4">
                            <i class="bi bi-award-fill"></i>
                            <strong>Congratulazioni, hai vinto!</strong><br>
                            Sarai contattato dall'admin per la spedizione.
                        </div>
                    </div>
                    <div th:if="${winner == null}" class="alert alert-warning mt-3">
                        L'asta si è conclusa senza offerte.
                    </div>
                </div>
            </div>

            <!-- Colonna 3: Attività (Grafico e Messaggi SEPARATI) -->
            <div class="col-lg-4 d-flex flex-column gap-4 activity-column">
                
                <!-- Box Grafico -->
                <div class="activity-box chart-box">
                    <h4 class="activity-title">Andamento Asta</h4>
                    <div class="bid-chart-container">
                        <div th:if="${product.bids.isEmpty()}" class="empty-state">
                            <span>Nessuna offerta ancora.</span>
                        </div>
                        <canvas id="bidHistoryChart" th:unless="${product.bids.isEmpty()}"></canvas>
                    </div>
                </div>

                <!-- Box Messaggi -->
                <div class="activity-box messages-box">
                    <h4 class="activity-title">Commenti dalla community</h4>
                    <div class="messages-list-main scrollable-content">
                        <div th:if="${product.comments.isEmpty()}" class="empty-state">
                           <span>Nessun messaggio.</span>
                        </div>
                        <div class="chat-message" th:each="comment : ${product.comments}">
                             <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong class="message-author" th:text="${comment.author?.name}">Autore</strong>
                                    <p class="message-text fst-italic fw-light my-1" th:text="'&quot;' + ${comment.title} + '&quot;'"></p>
                                </div>
                                <div class="message-actions" th:if="${#authorization.expression('hasRole(''ADMIN'')') or (#authorization.expression('isAuthenticated()') and #authentication.principal.username == comment.author?.credentials?.email)}">
                                    <a th:href="@{/comment/{id}/edit(id=${comment.id})}" class="btn-action edit" title="Modifica"><i class="bi bi-pencil-fill"></i></a>
                                    <form th:action="@{/comment/{id}/delete(id=${comment.id})}" method="post" class="d-inline" onsubmit="return confirm('Sei sicuro?');">
                                        <button type="submit" class="btn-action delete" title="Elimina"><i class="bi bi-trash-fill"></i></button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="message-form-container">
                        <div sec:authorize="isAuthenticated() and !hasRole('ADMIN')">
                            <a th:href="@{/products/{id}/comments/new(id=${product.id})}" class="btn btn-gold w-100">Lascia un commento</a>
                        </div>
                        <div sec:authorize="!isAuthenticated()">
                            <div class="login-prompt">
                                <span><a th:href="@{/login}">Accedi</a> per lasciare un messaggio.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Questo frammento ora contiene solo l'HTML e lo script per il toast generico -->
    <div th:fragment="footer">
      <!-- Toast per Funzioni non Disponibili -->
      <div class="toast-container position-fixed bottom-0 end-0 p-3">
          <div id="unavailableToast" class="toast align-items-center text-bg-dark border-gold" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="d-flex">
                  <div class="toast-body">
                      <i class="bi bi-info-circle-fill me-2"></i>
                      Al momento la funzione non è disponibile.
                  </div>
                  <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
          </div>
      </div>
      <!-- Lo script per attivare questo toast specifico -->
      <script>
          function showUnavailableToast() {
              const toastEl = document.getElementById('unavailableToast');
              const toast = new bootstrap.Toast(toastEl);
              toast.show();
          }
      </script>
    </div>


    <!-- ================================================================ -->
    <!-- SPOSTATO E RIORGANIZZATO: Sezione Script alla fine del body      -->
    <!-- ================================================================ -->
    
    <!-- 1. LIBRERIA BOOTSTRAP (FONDAMENTALE, DEVE ESSERE LA PRIMA) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 2. LIBRERIE PER IL GRAFICO -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- 3. SCRIPT PERSONALIZZATI (che usano le librerie di cui sopra) -->
    
    <!-- Script per inizializzare il grafico -->
    <script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function () {
        const chartCanvas = document.getElementById('bidHistoryChart');
        if (chartCanvas) {
            const startingPrice = /*[[${product.startingPrice}]]*/ 0;
            const labels = ['Inizio'];
            const dataPoints = [startingPrice];
            const pointBackgroundColors = ['#FFFFFF'];
            const pointBorderColors = ['#C9A227'];
            const userBidColor = '#28a745';
            const defaultBorderColor = '#C9A227';
            const defaultBgColor = '#FFFFFF';

            /*[# th:each="bid : ${product.getBidsChronological()}"]*/
            labels.push(new Date(/*[[${bid.timestamp}]]*/).toLocaleString('it-IT', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }));
            dataPoints.push(/*[[${bid.amount}]]*/);
            
            /*[# th:if="${#authorization.expression('isAuthenticated()') and bid.bidder?.credentials?.email == #authentication.principal.username}"]*/
            pointBackgroundColors.push(userBidColor);
            pointBorderColors.push(userBidColor);
            /*[/]*/
            
            /*[# th:unless="${#authorization.expression('isAuthenticated()') and bid.bidder?.credentials?.email == #authentication.principal.username}"]*/
            pointBackgroundColors.push(defaultBgColor);
            pointBorderColors.push(defaultBorderColor);
            /*[/]*/
            /*[/]*/

            const ctx = chartCanvas.getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, chartCanvas.offsetHeight);
            gradient.addColorStop(0, 'rgba(201, 162, 39, 0.5)');
            gradient.addColorStop(1, 'rgba(201, 162, 39, 0)');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Andamento Offerte',
                        data: dataPoints,
                        borderColor: '#C9A227',
                        pointBackgroundColor: pointBackgroundColors,
                        pointBorderColor: pointBorderColors,
                        pointHoverRadius: 7,
                        pointRadius: 5,
                        fill: true,
                        backgroundColor: gradient,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, ticks: { color: 'rgba(245, 245, 245, 0.6)', callback: function(value) { return '€ ' + value; }}, grid: { color: 'rgba(255, 255, 255, 0.1)' }},
                        x: { ticks: { color: 'rgba(245, 245, 245, 0.6)', maxRotation: 0, minRotation: 0, autoSkip: true, maxTicksLimit: 3 }, grid: { display: false }}
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false, callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.y !== null) { label += new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(context.parsed.y); } return label; }}}
                    }
                }
            });
        }
    });
    /*]]>*/
    </script>
    
    <!-- Script per il conto alla rovescia -->
    <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const countdownElement = document.getElementById('countdown-display');
        if (countdownElement) {
            const endDate = new Date(countdownElement.getAttribute('data-end-date')).getTime();
            const countdownInterval = setInterval(function() {
                const now = new Date().getTime();
                const distance = endDate - now;
                if (distance < 0) {
                    clearInterval(countdownInterval);
                    countdownElement.innerHTML = "Asta Terminata!";
                    setTimeout(() => window.location.reload(), 1500); 
                    return;
                }
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                let output = "";
                if (days > 0) output += `<span class="countdown-part">${days}g</span>`;
                if (hours > 0 || days > 0) output += (' ' + `<span class="countdown-part">${hours}h</span>`);
                if (minutes > 0 || hours > 0 || days > 0) output += (' ' + `<span class="countdown-part">${minutes}m</span>`);
                output += (' ' + `<span class="countdown-part">${seconds}s</span>`);
                countdownElement.innerHTML = output;
            }, 1000);
        }
    });
    </script>
    
    <!-- Script per mostrare il toast delle offerte -->
    <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const bidToastElement = document.getElementById('bidToast');
        if (bidToastElement) {
            const toast = new bootstrap.Toast(bidToastElement, { delay: 5000 });
            toast.show();
        }
    });
    </script>

</body>
</html>

